# ===========================================
# ğŸš€ GITLAB CI/CD PIPELINE FÃœR CYPRESS TESTS ğŸš€
# ===========================================
# Diese Pipeline fÃ¼hrt automatisch Cypress-Tests aus
# bei jedem Push und Merge Request

# ===========================================
# ğŸ“‹ STAGES DEFINITION
# ===========================================
stages:
  - install    # ğŸ“¦ Dependencies installieren
  - test       # ğŸ§ª Cypress Tests ausfÃ¼hren
  - report     # ğŸ“Š Test-Reports generieren

# ===========================================
# âš™ï¸ GLOBALE VARIABLEN
# ===========================================
variables:
  # ğŸŸ¢ Node.js Version
  NODE_VERSION: "18"
  
  # ğŸ”§ Cypress-spezifische Variablen
  CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/cache/Cypress"
  
  # ğŸ“ Test-Artifacts
  CYPRESS_SCREENSHOTS_FOLDER: "cypress/screenshots"
  CYPRESS_VIDEOS_FOLDER: "cypress/videos"
  CYPRESS_DOWNLOADS_FOLDER: "cypress/downloads"

# ===========================================
# ğŸ’¾ CACHE KONFIGURATION
# ===========================================
cache:
  key: 
    files:
      - package-lock.json
  paths:
    - node_modules/
    - cache/Cypress/

# ===========================================
# ğŸ“¦ STAGE 1: DEPENDENCIES INSTALLIEREN
# ===========================================
install_dependencies:
  stage: install
  image: node:${NODE_VERSION}-alpine
  
  script:
    # ğŸŸ¢ Node.js Version anzeigen
    - echo "ğŸŸ¢ Node.js Version: $(node --version)"
    - echo "ğŸ“¦ NPM Version: $(npm --version)"
    
    # ğŸ“¦ Dependencies installieren
    - echo "ğŸ“¦ Installiere Dependencies..."
    - npm ci --cache .npm --prefer-offline
    
    # ğŸ”§ Cypress installieren und cachen
    - echo "ğŸ”§ Installiere Cypress..."
    - npx cypress install --cache-from $CYPRESS_CACHE_FOLDER
    
    # âœ… Installation verifizieren
    - echo "âœ… Verifiziere Cypress Installation..."
    - npx cypress verify
    
  artifacts:
    paths:
      - node_modules/
      - cache/
    expire_in: 1 hour

# ===========================================
# ğŸ§ª STAGE 2: CYPRESS TESTS AUSFÃœHREN
# ===========================================
cypress_tests:
  stage: test
  image: cypress/browsers:node-18.16.0-chrome-114.0.5735.133-ff-114.0.2-edge-114.0.1823.51-1.40.0
  
  # ğŸ”— AbhÃ¤ngigkeit von install_dependencies
  needs: ["install_dependencies"]
  
  # ğŸŒ¿ Nur bei bestimmten Branches ausfÃ¼hren
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  
  before_script:
    # ğŸŒ Browser-Informationen anzeigen
    - echo "ğŸŒ Browser-Informationen:"
    - google-chrome --version || true
    - firefox --version || true
    
    # âš™ï¸ Cypress-Konfiguration anzeigen
    - echo "âš™ï¸ Cypress-Konfiguration:"
    - npx cypress info || true
  
  script:
    # ğŸš€ Test-AusfÃ¼hrung starten
    - echo "ğŸš€ Starte Cypress Tests..."
    - echo "ğŸ“„ Test-Dateien:"
    - find cypress/e2e -name "*.cy.js" -type f
    
    # ğŸ§ª Cypress Tests im Headless-Modus ausfÃ¼hren
    - echo "ğŸ§ª FÃ¼hre Cypress Tests aus..."
    - npx cypress run
      --browser chrome
      --headless
      --reporter junit
      --reporter-options "mochaFile=cypress/results/results-[hash].xml"
      --config screenshotOnRunFailure=true
    
    # ğŸ“Š Test-Ergebnisse anzeigen
    - echo "ğŸ“Š Test-Ergebnisse:"
    - ls -la cypress/results/ || echo "âŒ Keine JUnit-Ergebnisse gefunden"
    - ls -la cypress/screenshots/ || echo "âŒ Keine Screenshots gefunden"
  
  # ğŸ“¦ Artifacts sammeln
  artifacts:
    when: always  # Auch bei Fehlern sammeln
    paths:
      - cypress/screenshots/
      - cypress/downloads/
      - cypress/results/
    reports:
      junit: cypress/results/results-*.xml
    expire_in: 1 week

# ===========================================
# ğŸ“Š STAGE 3: TEST-REPORTS GENERIEREN
# ===========================================
generate_reports:
  stage: report
  image: node:${NODE_VERSION}-alpine
  
  # ğŸ”— Nur ausfÃ¼hren wenn Tests erfolgreich waren
  needs: 
    - job: cypress_tests
      artifacts: true
  
  script:
    # ğŸ“‹ Test-Report zusammenfassen
    - echo "ğŸ“‹ Generiere Test-Report..."
    - echo "==========================================="
    - echo "ğŸ§ª CYPRESS TEST SUMMARY ğŸ§ª"
    - echo "==========================================="
    
    # ğŸ“¸ Screenshots zÃ¤hlen
    - echo "ğŸ“¸ Screenshots:"
    - find cypress/screenshots -name "*.png" | wc -l || echo "0"
    
    # ğŸ“Š JUnit-Ergebnisse anzeigen (falls vorhanden)
    - echo "ğŸ“Š JUnit-Ergebnisse:"
    - find cypress/results -name "*.xml" -exec echo "âœ… Gefunden: {}" \; || echo "âŒ Keine JUnit-Ergebnisse"
    
    # ğŸ“ Test-Artifacts auflisten
    - echo "ğŸ“ VerfÃ¼gbare Artifacts:"
    - ls -la cypress/ || echo "âŒ Keine Artifacts gefunden"
  
  artifacts:
    when: always
    paths:
      - cypress/
    expire_in: 1 week

# ===========================================
# ğŸ”§ OPTIONAL: MANUELLE TEST-AUSFÃœHRUNG
# ===========================================
manual_cypress_tests:
  stage: test
  image: cypress/browsers:node-18.16.0-chrome-114.0.5735.133-ff-114.0.2-edge-114.0.1823.51-1.40.0
  
  # ğŸ‘† Nur manuell ausfÃ¼hrbar
  when: manual
  allow_failure: true
  
  script:
    - echo "ğŸ”§ Manuelle Test-AusfÃ¼hrung..."
    - echo "ğŸŒ VerfÃ¼gbare Browser:"
    - google-chrome --version || true
    - firefox --version || true
    
    # ğŸ–¥ï¸ Interaktiver Modus (fÃ¼r Debugging)
    - echo "ğŸ–¥ï¸ Starte Cypress im interaktiven Modus..."
    - npx cypress open --browser chrome


# ===========================================
# ğŸ¯ PIPELINE ZUSAMMENFASSUNG
# ===========================================
# Diese Pipeline bietet:
# ğŸ“¦ Automatische Dependency-Installation
# ğŸ§ª Cypress-Tests in Chrome Browser
# ğŸ“Š Detaillierte Test-Reports
# ğŸ“¸ Screenshots bei Fehlern
# ğŸ”§ Manuelle Test-AusfÃ¼hrung fÃ¼r Debugging
# ===========================================